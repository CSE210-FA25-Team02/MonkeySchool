# ============================================================================
# MonkeySchool Fluent Bit Configuration - Simple Working Version
# Captures HTTP access logs and stores them in TimescaleDB with simple parsing
# ============================================================================

[SERVICE]
    Flush         1
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020
    Log_Level     debug
    Parsers_File  parsers.conf

# ============================================================================
# INPUT SOURCES
# ============================================================================
[INPUT]
    Name              syslog
    Listen            0.0.0.0
    Port              5140
    Parser            syslog_basic
    Mode              udp
    Tag               docker.app

# ============================================================================
# FILTERS - Process only HTTP access logs
# ============================================================================

# Filter to only process logs that contain HTTP/1.1 (real access logs)
[FILTER]
    Name    grep
    Match   docker.app*
    Regex   message .*HTTP/1\.1

# Parse Morgan combined format access logs from Docker JSON log field
[FILTER]
    Name         parser
    Match        docker.app*
    Key_Name     message
    Parser       morgan_combined
    Reserve_Data On

# Add required metadata
[FILTER]
    Name   modify
    Match  docker.app*
    Add    service monkeyschool
    Add    environment development

# ============================================================================
# OUTPUTS
# ============================================================================

# Send logs to Grafana Loki
[OUTPUT]
    Name                loki
    Match               docker.app*
    Host                monkeyschool-grafana
    Port                3100
    Labels              app=monkeyschool, environment=development
    Label_keys          $service, $environment
    Line_format         json
    Remove_keys         date

# Debug output to see what's being processed  
[OUTPUT]
    Name   stdout
    Match  *
    Format json_lines