# ============================================================================
# MonkeySchool Fluent Bit Configuration - FIXED VERSION
# Fixes the bigint error by using proper HTTP output instead of direct PostgreSQL
# ============================================================================

[SERVICE]
    Flush         1
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020
    Log_Level     debug
    Parsers_File  parsers.conf

# ============================================================================
# INPUT SOURCES
# ============================================================================
[INPUT]
    Name              syslog
    Listen            0.0.0.0
    Port              5140
    Parser            syslog_basic
    Mode              udp
    Tag               monkeyschool.syslog

# ============================================================================
# FILTERS - Process and transform logs
# ============================================================================

# Filter to only process HTTP access logs
[FILTER]
    Name    grep
    Match   monkeyschool.syslog
    Regex   message .*HTTP/1\.1

[FILTER]
    Name         parser
    Match        monkeyschool.syslog
    Key_Name     message
    Parser       http_strict
    Reserve_Data Off
# Parse Morgan combined format from syslog message
# [FILTER]
#     Name         parser
#     Match        monkeyschool.syslog
#     Key_Name     message
#     Parser       morgan_combined
#     Reserve_Data On

# # Transform parsed fields for database compatibility
# [FILTER]
#     Name    lua
#     Match   monkeyschool.syslog
#     Script  /fluent-bit/transform_logs.lua
#     Call    transform_http_log

# # Add metadata
# [FILTER]
#     Name   modify
#     Match  monkeyschool.syslog
#     Add    service monkeyschool
#     Add    environment development

# ============================================================================
# OUTPUTS
# ============================================================================
[OUTPUT]
    Name                loki
    Match               *
    Host                monkeyschool-loki
    Port                3100
    # Add useful labels for searching in Grafana
    Labels              app=monkeyschool
    # We explicitly convert the extracted fields to JSON format for Loki
    Line_format         json
# Debug output
[OUTPUT]
    Name   stdout
    Match  *
    Format json_lines