# ============================================================================
# MonkeySchool Log Parsers Configuration
# Defines how to parse different log formats from the application
# ============================================================================

# ============================================================================
# SYSLOG PARSERS
# ============================================================================

[PARSER]
    Name         syslog_basic
    # 1. Strips the <30>Dec... header so we get the clean message
    Format       regex
    Regex        ^\<(?<pri>[0-9]+)\>(?<time>[^ ]* {1,2}[^ ]* [^ ]*) (?<host>[^ ]*) (?<ident>[a-zA-Z0-9_\/\.\-]*)(?:\[(?<pid>[0-9]+)\])?(?:[^\:]*\:)? *(?<message>.*)$
    Time_Key     time
    Time_Format  %b %d %H:%M:%S
    Time_Keep    Off

[PARSER]
    Name         http_strict
    Format       regex
    # Matches: IP - User [Time] "Method URL Protocol" Code
    Regex        ^(?<ip>[^ ]*) [^ ]* (?<requester_id>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+) (?<url>[^\"]*) (?<http_ver>[^\"]*)" (?<code>[^ ]*)
    Time_Key     time
    Time_Format  %d/%b/%Y:%H:%M:%S %z

# ============================================================================
# MORGAN HTTP ACCESS LOG PARSERS
# ============================================================================

# Morgan "dev" format parser (colored output)
# Example: GET / 302 1.452 ms - 28
[PARSER]
    Name         morgan_dev
    Format       regex
    Regex        ^(?<method>\w+)\s+(?<url>\S+)\s+(?<status_code>\d+)\s+(?<response_time>[\d.]+)\s*ms\s*-\s*(?<response_size>\d+)
    Time_Key     timestamp
    Time_Format  %Y-%m-%dT%H:%M:%S.%L%z

# Morgan "combined" format parser (Apache combined log format)
# Example: ::ffff:192.168.65.1 - - [10/Dec/2025:00:35:58 +0000] "GET / HTTP/1.1" 302 28 "-" "curl/8.6.0"
[PARSER]
    Name         morgan_combined
    Format       regex
    Regex        ^(?<ip>[^\s]+)\s+\S+\s+(?<user>\S+)\s+\[(?<time>[^\]]+)\]\s+"(?<method>\S+)\s+(?<url>\S+)\s+(?<http_version>\S+)"\s+(?<status_code>\d+)\s+(?<response_size>\S+)\s+"(?<referer>[^"]*)"\s+"(?<user_agent>[^"]*)"
    Time_Key     time
    Time_Format  %d/%b/%Y:%H:%M:%S %z

# Morgan "common" format parser
[PARSER]
    Name         morgan_common
    Format       regex
    Regex        ^(?<ip>\S+)\s+\S+\s+(?<user>\S+)\s+\[(?<time>[^\]]+)\]\s+"(?<method>\S+)\s+(?<url>\S+)\s+(?<http_version>\S+)"\s+(?<status_code>\d+)\s+(?<response_size>\d+)
    Time_Key     time
    Time_Format  %d/%b/%Y:%H:%M:%S %z

# ============================================================================
# MONKEYSCHOOL APPLICATION LOG PARSERS
# ============================================================================

# General MonkeySchool application log parser (console.log output)
[PARSER]
    Name         monkeyschool_log
    Format       regex
    Regex        ^(?<level>\w+):\s*(?<message>.*)$
    Time_Key     timestamp
    Time_Format  %Y-%m-%dT%H:%M:%S.%L%z

# MonkeySchool error log parser (console.error with stack traces)
[PARSER]
    Name         monkeyschool_error
    Format       regex
    Regex        ^(?<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z)\s+(?<level>ERROR)\s+(?<message>.*?)(?:\n(?<stack_trace>[\s\S]*))?$
    Time_Key     timestamp
    Time_Format  %Y-%m-%dT%H:%M:%S.%L%z

# Authentication related logs
[PARSER]
    Name         auth_log
    Format       regex
    Regex        ^.*(?<action>login|logout|authentication).*user[:\s]+(?<user_email>[\w@.-]+).*$
    Time_Key     timestamp
    Time_Format  %Y-%m-%dT%H:%M:%S.%L%z

# Database query logs
[PARSER]
    Name         database_log
    Format       regex
    Regex        ^.*(?<operation>SELECT|INSERT|UPDATE|DELETE|CREATE).*(?<duration>[\d.]+)ms.*(?<table>\w+)
    Time_Key     timestamp
    Time_Format  %Y-%m-%dT%H:%M:%S.%L%z

# ============================================================================
# JSON LOG PARSERS
# ============================================================================

# Generic JSON parser for structured logs
[PARSER]
    Name         json
    Format       json
    Time_Key     timestamp
    Time_Format  %Y-%m-%dT%H:%M:%S.%L%z

# JSON parser with nested objects support
[PARSER]
    Name         json_nested
    Format       json
    Time_Key     '@timestamp'
    Time_Format  %Y-%m-%dT%H:%M:%S.%L%z

# ============================================================================
# TIMESTAMP PARSERS
# ============================================================================

# ISO 8601 timestamp parser
[PARSER]
    Name         timestamp_iso8601
    Format       regex
    Regex        ^(?<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d{3})?(?:Z|[+-]\d{2}:\d{2}))
    Time_Key     timestamp
    Time_Format  %Y-%m-%dT%H:%M:%S.%L%z

# Unix timestamp parser
[PARSER]
    Name         timestamp_unix
    Format       regex
    Regex        ^(?<timestamp>\d{10}(?:\.\d{3})?)
    Time_Key     timestamp
    Time_Format  %s

# ============================================================================
# DOCKER CONTAINER LOG PARSERS
# ============================================================================

# Docker container log parser (standard Docker logging driver)
[PARSER]
    Name         docker_json
    Format       json
    Time_Key     time
    Time_Format  %Y-%m-%dT%H:%M:%S.%L%z
    Time_Keep    On

# Docker container log parser with additional metadata
[PARSER]
    Name         docker_container
    Format       regex
    Regex        ^(?<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{9}Z)\s+(?<stream>stdout|stderr)\s+(?<partial_flag>[FP])\s+(?<log>.*)$
    Time_Key     timestamp
    Time_Format  %Y-%m-%dT%H:%M:%S.%L%z

# ============================================================================
# PERFORMANCE/METRICS PARSERS
# ============================================================================

# Response time parser for performance monitoring
[PARSER]
    Name         response_time
    Format       regex
    Regex        ^.*(?<operation>\w+).*took\s+(?<duration>[\d.]+)(?<unit>ms|s)
    Time_Key     timestamp
    Time_Format  %Y-%m-%dT%H:%M:%S.%L%z

# Memory usage parser
[PARSER]
    Name         memory_usage
    Format       regex
    Regex        ^.*memory.*(?<usage>[\d.]+)(?<unit>MB|GB|KB)
    Time_Key     timestamp
    Time_Format  %Y-%m-%dT%H:%M:%S.%L%z

# ============================================================================
# SECURITY LOG PARSERS
# ============================================================================

# Failed login attempts
[PARSER]
    Name         failed_login
    Format       regex
    Regex        ^.*(?<action>failed|invalid).*login.*(?<email>[\w@.-]+).*from\s+(?<ip>[\d.]+)
    Time_Key     timestamp
    Time_Format  %Y-%m-%dT%H:%M:%S.%L%z

# Permission denied events
[PARSER]
    Name         permission_denied
    Format       regex
    Regex        ^.*(?<action>permission|access).*denied.*user[:\s]+(?<user_id>\w+).*resource[:\s]+(?<resource>\S+)
    Time_Key     timestamp
    Time_Format  %Y-%m-%dT%H:%M:%S.%L%z

# ============================================================================
# BUSINESS ANALYTICS PARSERS
# ============================================================================

# User activity parser
[PARSER]
    Name         user_activity
    Format       regex
    Regex        ^.*user[:\s]+(?<user_id>\w+).*(?<action>viewed|clicked|submitted).*(?<resource>\w+)
    Time_Key     timestamp
    Time_Format  %Y-%m-%dT%H:%M:%S.%L%z