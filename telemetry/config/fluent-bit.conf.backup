# ============================================================================
# MonkeySchool Fluent Bit Configuration
# Collects logs from MonkeySchool application and routes to TimescaleDB
# ============================================================================

[SERVICE]
    # Flush logs every 5 seconds
    Flush         5
    # Enable Fluent Bit HTTP server for metrics/health
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020
    # Log level (error, warning, info, debug, trace)
    Log_Level     info
    # Enable storage buffer for reliability
    storage.path              /tmp/fluent-bit-storage/
    storage.sync              normal
    storage.checksum          off
    storage.backlog.mem_limit 5M
    # Include parsers configuration
    Parsers_File  parsers.conf

# ============================================================================
# INPUT SOURCES - Where logs come from
# ============================================================================

# Monitor application stdout/stderr from Docker containers
[INPUT]
    Name              forward
    Listen            0.0.0.0
    Port              24224
    Buffer_Chunk_Size 32k
    Buffer_Max_Size   64k
    Tag               docker.*

# Monitor application log files (if your app writes to files)
[INPUT]
    Name              tail
    Path              /var/log/app/*.log
    Tag               app.file
    Parser            json
    Refresh_Interval  5
    Rotate_Wait       30
    storage.type      filesystem

# Monitor system metrics (optional)
# [INPUT]
#     Name   cpu
#     Tag    metrics.cpu
#     Interval_Sec 30

# [INPUT]
#     Name   mem
#     Tag    metrics.memory
#     Interval_Sec 30

# ============================================================================
# FILTERS - Log processing and enrichment
# ============================================================================

# Parse MonkeySchool application logs
[FILTER]
    Name         parser
    Match        docker.monkeyschool*
    Key_Name     log
    Parser       monkeyschool_log
    Reserve_Data On

# Add environment and service metadata
[FILTER]
    Name   modify
    Match  docker.monkeyschool*
    Add    service monkeyschool
    Add    environment development
    Add    version 1.0.0

# Parse Morgan HTTP access logs
[FILTER]
    Name         parser
    Match        docker.monkeyschool*
    Key_Name     log
    Parser       morgan_combined
    Reserve_Data On

# Extract user information from logs (if available)
[FILTER]
    Name    grep
    Match   docker.monkeyschool*
    Regex   log userId|user_id|email

# Add timestamp parsing for consistent time handling
[FILTER]
    Name   parser
    Match  docker.monkeyschool*
    Key_Name time
    Parser timestamp_iso8601
    Reserve_Data On

# Route logs based on content type
[FILTER]
    Name    rewrite_tag
    Match   docker.monkeyschool*
    Rule    $log ^.*GET|POST|PUT|DELETE.*$ http_access false
    Rule    $log ^.*ERROR.*$ application_error false
    Rule    $log ^.*authentication.*|.*login.*|.*logout.*$ security false
    Rule    $log ^.*ms.*response.*$ performance false
    Emitter_Name re_emitted

# Add additional context to HTTP logs
[FILTER]
    Name   modify
    Match  http_access
    Add    log_category http_access

# ============================================================================
# OUTPUTS - Where logs are sent
# ============================================================================

# Send HTTP access logs to TimescaleDB
[OUTPUT]
    Name              pgsql
    Match             http_access
    Host              timescaledb
    Port              5432
    User              telemetry
    Password          telemetry123
    Database          logs
    Table             http_logs
    Timestamp_Key     timestamp
    storage.total_limit_size 512M

# Send application logs to TimescaleDB
[OUTPUT]
    Name              pgsql
    Match             application_error
    Host              timescaledb
    Port              5432
    User              telemetry
    Password          telemetry123
    Database          logs
    Table             application_logs
    Timestamp_Key     timestamp

# Send security logs to TimescaleDB
[OUTPUT]
    Name              pgsql
    Match             security
    Host              timescaledb
    Port              5432
    User              telemetry
    Password          telemetry123
    Database          logs
    Table             security_logs
    Timestamp_Key     timestamp

# Send performance logs to TimescaleDB
[OUTPUT]
    Name              pgsql
    Match             performance
    Host              timescaledb
    Port              5432
    User              telemetry
    Password          telemetry123
    Database          logs
    Table             performance_logs
    Timestamp_Key     timestamp

# Send all logs to stdout for debugging
[OUTPUT]
    Name   stdout
    Match  docker.monkeyschool*
    Format json

# File output removed due to path issues - using stdout instead

# Send metrics to stdout for monitoring
[OUTPUT]
    Name   stdout
    Match  metrics.*
    Format json